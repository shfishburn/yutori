<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <!-- Added shrink-to-fit and description for consistency -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no" />
    <meta name="description" content="Yutori Labs - Body Composition Calculator V1" />
    <title>Body Composition Calculator V1</title>
    <!-- Include Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="../styles.css" />
    <link rel="stylesheet" href="calc-styles.css" />
    <!-- Chart.js for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <nav class="nav-wrapper">
      <div class="container">
        <a href="../index.html">
          <img src="../assets/logo_400px_wide.png" alt="Yutori Labs" class="logo" />
        </a>
      </div>
    </nav>

    <section id="calculator" class="projects-section">
      <div class="container">
        <h1>Body Composition Calculator</h1>
        <p>This calculator determines your body composition goals based on the step-by-step data you provide.</p>
    
        <!-- Step 1: Mode & Units -->
        <div class="wizard-step" id="step1" style="display: block;">
          <h2>Step 1: Mode & Units</h2>
          <div class="radio-group">
            <label>
              <input type="radio" name="inputMode" value="leanFat" id="radioLeanFat" />
              Lean/Fat mass
            </label>
            <label>
              <input type="radio" name="inputMode" value="weightBF" id="radioWeightBF" checked />
              Weight + BF%
            </label>
          </div>
          <div class="radio-group">
            <label>
              <input type="radio" name="unit" value="lbs" id="radioLbs" checked />
              lbs
            </label>
            <label>
              <input type="radio" name="unit" value="kg" id="radioKg" />
              kg
            </label>
          </div>
          <div class="wizard-buttons">
            <button type="button" class="btn" data-next-step>Next</button>
          </div>
        </div>
    
        <!-- Step 2: Age & Gender -->
        <div class="wizard-step" id="step2">
          <h2>Step 2: Age & Gender</h2>
          <label>AGE:</label>
          <input type="number" id="ageInput" min="20" max="69" />
          <div class="radio-group">
            <label>
              <input type="radio" name="gender" value="female" id="radioFemale" checked />
              Female
            </label>
            <label>
              <input type="radio" name="gender" value="male" id="radioMale" />
              Male
            </label>
          </div>
          <div class="wizard-buttons">
            <button type="button" class="btn" data-prev-step>Back</button>
            <button type="button" class="btn" data-next-step>Next</button>
          </div>
        </div>
    
        <!-- Step 3: Composition -->
        <div class="wizard-step" id="step3">
          <h2>Step 3: Composition</h2>
          <div id="leanFatSection" style="display: none;">
            <label>LEAN MASS:</label>
            <input type="number" id="leanMassInput" />
            <label>FAT MASS:</label>
            <input type="number" id="fatMassInput" />
          </div>
          <div id="weightBFSection">
            <label>TOTAL WEIGHT:</label>
            <input type="number" id="totalWeightInput" />
            <label>BODY FAT (%):</label>
            <input type="number" id="bodyFatPctInput" step="0.1" />
          </div>
          <div class="wizard-buttons">
            <button type="button" class="btn" data-prev-step>Back</button>
            <button type="button" class="btn" data-next-step>Next</button>
          </div>
        </div>
    
        <!-- Step 4: Goals, Activity & Calorie Adjustment -->
        <div class="wizard-step" id="step4">
          <h2>Step 4: Goals & Activity</h2>
          <p><a href="#" data-open-modal="weightGoalModal">Weight Goal Info</a></p>
          <div class="radio-group">
            <label>
              <input type="radio" name="weightGoal" value="lose" id="loseWeight" checked />
              Lose Weight
            </label>
          </div>
          <p><a href="#" data-open-modal="dietaryApproachModal">Dietary Approach Info</a></p>
          <div class="radio-group">
            <label>
              <input type="radio" name="dietaryApproach" value="low-carb" id="lowCarb" />
              Low-Carb
            </label>
            <label>
              <input type="radio" name="dietaryApproach" value="high-protein" id="highProtein" />
              High-Protein
            </label>
            <label>
              <input type="radio" name="dietaryApproach" value="balanced" id="balancedMacros" checked />
              Balanced
            </label>
          </div>
          <p><a href="#" data-open-modal="activityLevelModal">Activity Info</a></p>
          <select id="activityLevelSelect">
            <option value="1.2">Sedentary (1.2)</option>
            <option value="1.375">Light (1.375)</option>
            <option value="1.55" selected>Moderate (1.55)</option>
            <option value="1.725">Very Active (1.725)</option>
            <option value="1.9">Extremely Active (1.9)</option>
          </select>
          <p><a href="#" data-open-modal="calorieDeficitModal">Calorie Adjustment Info</a></p>
          <select id="dailyAdjustmentSelect"></select>
          <p><a href="#" data-open-modal="fatRangeModal">Fat% Range Info</a></p>
          <select id="fatGoalCategorySelect">
            <option value="dangerouslyLow">Dangerously Low</option>
            <option value="excellent" selected>Excellent</option>
            <option value="good">Good</option>
            <option value="fair">Fair</option>
            <option value="poor">Poor</option>
            <option value="dangerouslyHigh">Dangerously High</option>
          </select>
          <div class="wizard-buttons">
            <button type="button" class="btn" data-prev-step>Back</button>
            <button type="button" class="btn" id="calculateButton">Calculate</button>
          </div>
        </div>
    
        <!-- Step 5: Results (with Forecast Charts) -->
        <div class="wizard-step" id="step5">
          <div class="max-w-4xl mx-auto p-4">
            <h2 class="text-3xl font-bold text-center mb-6">Your Results</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              <!-- Settings Card -->
              <div class="bg-white shadow rounded p-4">
                <h3 class="text-xl font-semibold border-b pb-2 mb-2">Settings</h3>
                <ul class="space-y-1 text-sm">
                  <li><strong>Goal:</strong> <span id="summaryWeightGoal">--</span></li>
                  <li><strong>Dietary Approach:</strong> <span id="summaryDietApproach">--</span></li>
                  <li><strong>Activity:</strong> <span id="summaryActivityLevel">--</span></li>
                  <li><strong>Daily Calorie Adjustment:</strong> <span id="summaryDailyAdj">--</span></li>
                  <li><strong>Lean Goal:</strong> <span id="summaryLeanGoalPct">--</span></li>
                </ul>
              </div>
    
              <!-- Current Composition Card -->
              <div class="bg-white shadow rounded p-4">
                <h3 class="text-xl font-semibold border-b pb-2 mb-2">Current Composition</h3>
                <ul class="space-y-1 text-sm">
                  <li><strong>Weight:</strong> <span id="currentWeightSpan">--</span></li>
                  <li><strong>Fat Mass:</strong> <span id="currentFatSpan">--</span></li>
                  <li><strong>Lean Mass:</strong> <span id="currentLeanSpan">--</span></li>
                  <li><strong>BF%:</strong> <span id="currentBFpctSpan">--</span></li>
                  <li><strong>Category:</strong> <span id="currentBFcatSpan">--</span></li>
                </ul>
              </div>
    
              <!-- Goal Range Card -->
              <div class="bg-white shadow rounded p-4">
                <h3 class="text-xl font-semibold border-b pb-2 mb-2">Goal Range</h3>
                <ul class="space-y-1 text-sm">
                  <li><strong>Weight:</strong> <span id="goalWeightSpan">--</span></li>
                  <li><strong>Fat Mass:</strong> <span id="goalFatSpan">--</span></li>
                  <li><strong>Lean Mass:</strong> <span id="goalLeanSpan">--</span></li>
                  <li><strong>BF%:</strong> <span id="goalBFpctSpan">--</span></li>
                  <li><strong>Category:</strong> <span id="goalBFcatSpan">--</span></li>
                </ul>
              </div>
    
              <!-- Forecast Charts Card (spanning two columns on medium screens) -->
              <div class="bg-white shadow rounded p-4 md:col-span-2">
                <h3 class="text-xl font-semibold border-b pb-2 mb-2">Forecast Charts</h3>
                <div class="grid grid-cols-1 gap-4">
                  <canvas id="calorieChart" class="w-full h-64"></canvas>
                  <canvas id="macroChart" class="w-full h-64"></canvas>
                  <canvas id="weightChart" class="w-full h-64"></canvas>
                </div>
                <p class="mt-4 text-sm">
                  These charts show your projected daily calorie target, macronutrient needs, and weight loss trajectory over time. As you lose weight, your metabolism adapts, and your targets adjust accordingly.
                </p>
                <p class="mt-2 text-xs text-gray-500">
                  Disclaimer: These projections are estimates based on current research and individual results may vary. Consult a healthcare professional for personalized advice.
                </p>
              </div>
    
              <!-- Time-to-Goal Card -->
              <div class="bg-white shadow rounded p-4">
                <h3 class="text-xl font-semibold border-b pb-2 mb-2">Time to Mid-Goal</h3>
                <p class="text-sm" id="timeToGoalText">--</p>
              </div>
            </div>
    
            <!-- Bottom Buttons -->
            <div class="mt-6 text-center">
              <button class="btn px-4 py-2 bg-gray-700 text-white mr-2" id="newScenarioBtn">New Scenario</button>
              <button class="btn px-4 py-2 bg-gray-500 text-white" id="disclaimerLink">Disclaimer</button>
            </div>
          </div>
        </div>
    
      </div>
    </section>
    
    <!-- Modals -->
    <div class="modal-overlay" id="weightGoalModal">
      <div class="modal-content">
        <h3>Weight Goal</h3>
        <p>Lose, Maintain, or Gain Lean Mass. Adjusts your final daily calories.</p>
        <button class="close-modal-btn" data-close-modal="weightGoalModal">Exit</button>
      </div>
    </div>
    
    <div class="modal-overlay" id="dietaryApproachModal">
      <div class="modal-content">
        <h3>Dietary Approach</h3>
        <p>Low-carb, High-protein, or Balanced macros. Adjusts carb/fat split.</p>
        <button class="close-modal-btn" data-close-modal="dietaryApproachModal">Exit</button>
      </div>
    </div>
    
    <div class="modal-overlay" id="activityLevelModal">
      <div class="modal-content">
        <h3>Activity Level</h3>
        <p>Factor to multiply your BMR. Sedentary ~1.2, Very Active ~1.725, etc.</p>
        <button class="close-modal-btn" data-close-modal="activityLevelModal">Exit</button>
      </div>
    </div>
    
    <div class="modal-overlay" id="calorieDeficitModal">
      <div class="modal-content">
        <h3>Calorie Adjustment Info</h3>
        <p>
          Depending on your weight goal, select an option from the dropdown below:
          <br /><br />
          <strong>Weight Maintenance:</strong><br />
          Maintain: (0 cal/day) ≈ no weight change
          <br /><br />
          <strong>Weight Loss:</strong><br />
          Slow loss: (~250 cal/day deficit) ≈ 0.5 lb/week<br />
          Moderate loss: (~500 cal/day deficit) ≈ 1 lb/week<br />
          Rapid loss: (~750 cal/day deficit) ≈ 1.5 lb/week<br />
          Dangerous loss: (~1,000+ cal/day deficit) ≈ 2 lb/week or more
          <br /><br />
          <strong>Weight Gain:</strong><br />
          Slow gain: (~125 cal/day surplus) ≈ 0.25 lb/week<br />
          Moderate gain: (~250–500 cal/day surplus) ≈ 0.5–1 lb/week<br />
          Rapid gain: (~500–750 cal/day surplus) ≈ 1–1.5 lb/week<br />
          Dangerous gain: (~750+ cal/day surplus) ≈ 1.5+ lb/week
        </p>
        <button class="close-modal-btn" data-close-modal="calorieDeficitModal">Exit</button>
      </div>
    </div>
    
    <div class="modal-overlay" id="leanMassGoalModal">
      <div class="modal-content">
        <h3>Lean Goal (%)</h3>
        <p>Percentage of lost/gained weight that is lean mass vs. fat mass.</p>
        <button class="close-modal-btn" data-close-modal="leanMassGoalModal">Exit</button>
      </div>
    </div>
    
    <div class="modal-overlay" id="fatRangeModal">
      <div class="modal-content">
        <h3>Fat% Range</h3>
        <p>Select an overall body-fat range category. e.g., "excellent" ~10-15% BF.</p>
        <button class="close-modal-btn" data-close-modal="fatRangeModal">Exit</button>
      </div>
    </div>
    
    <div class="modal-overlay" id="disclaimerModal">
      <div class="modal-content">
        <h3>Disclaimer</h3>
        <p>This is not medical advice. Just estimates. Consult a professional.</p>
        <button class="close-modal-btn" data-close-modal="disclaimerModal">Exit</button>
      </div>
    </div>
    
    <script>
      (function () {
        "use strict";
    
        // --- Helper: setTextContent with defensive check ---
        function setTextContent(id, value) {
          const el = document.getElementById(id);
          if (!el) {
            console.error(`Element with id '${id}' not found.`);
            return;
          }
          el.textContent = value;
        }
    
        // --- Helper Functions ---
        function fmtWeight(weight, isKg) {
          if (typeof weight !== "number") {
            console.error("fmtWeight expects a number; received:", typeof weight);
            return "";
          }
          return isKg ? (weight / 2.20462).toFixed(2) + " kg" : weight.toFixed(2) + " lbs";
        }
    
        function getBFCat(ratio) {
          if (ratio < 0.1) return "Very Low";
          if (ratio < 0.15) return "Excellent";
          if (ratio < 0.2) return "Good";
          if (ratio < 0.25) return "Fair";
          if (ratio < 0.3) return "Poor";
          return "Very High";
        }
    
        function computeMacros(finalCals, approach) {
          let macros = {};
          if (approach === "balanced") {
            macros.carbsGrams = Math.round((finalCals * 0.40) / 4);
            macros.proteinGrams = Math.round((finalCals * 0.30) / 4);
            macros.fatGrams = Math.round((finalCals * 0.30) / 9);
          } else if (approach === "low-carb") {
            macros.carbsGrams = Math.round((finalCals * 0.25) / 4);
            macros.proteinGrams = Math.round((finalCals * 0.40) / 4);
            macros.fatGrams = Math.round((finalCals * 0.35) / 9);
          } else if (approach === "high-protein") {
            macros.carbsGrams = Math.round((finalCals * 0.35) / 4);
            macros.proteinGrams = Math.round((finalCals * 0.45) / 4);
            macros.fatGrams = Math.round((finalCals * 0.20) / 9);
          } else {
            macros.carbsGrams = Math.round((finalCals * 0.40) / 4);
            macros.proteinGrams = Math.round((finalCals * 0.30) / 4);
            macros.fatGrams = Math.round((finalCals * 0.30) / 9);
          }
          return macros;
        }
    
        function getAdvice(netDiff) {
          if (netDiff < 0) return "Calorie deficit: aiming for weight loss.";
          if (netDiff > 0) return "Calorie surplus: aiming for weight gain.";
          return "Calorie maintenance.";
        }
    
        // --- New Time-to-Mid-Goal Calculation ---
        function timeToGoal(cWeight, goalWeight, finalCals, TDEE, isKg) {
          let netDiff = TDEE - finalCals;
          let absNetDiff = Math.abs(netDiff);
          if (absNetDiff === 0) {
            setTextContent("timeToGoalText", "No calorie change – time cannot be determined.");
            return;
          }
          let weightDiff = Math.abs(cWeight - goalWeight);
          let weeklyChange = (absNetDiff * 7) / 3500;
          if (weeklyChange === 0) {
            setTextContent("timeToGoalText", "Insufficient deficit for measurable weight change.");
            return;
          }
          let weeks = (weightDiff / 2) / weeklyChange;
          weeks = Math.round(weeks * 10) / 10;
          setTextContent("timeToGoalText", weeks + " weeks to mid-goal");
        }
    
        // --- Chart Rendering ---
        let calorieChart, macroChart, weightChart;
        function renderForecastCharts(weeklyData) {
          try {
            const weeks = weeklyData.map(pt => pt.week);
            const calorieTargets = weeklyData.map(pt => Math.round(pt.calorieTarget));
            const weights = weeklyData.map(pt => Math.round(pt.weight));
            const proteins = weeklyData.map(pt => pt.macros.protein);
            const carbs = weeklyData.map(pt => pt.macros.carbs);
            const fats = weeklyData.map(pt => pt.macros.fat);
    
            // Calorie Forecast Chart
            if (calorieChart) calorieChart.destroy();
            const ctxCal = document.getElementById("calorieChart").getContext("2d");
            calorieChart = new Chart(ctxCal, {
              type: "line",
              data: {
                labels: weeks,
                datasets: [{
                  label: "Daily Calorie Target",
                  data: calorieTargets,
                  borderColor: "rgb(75, 192, 192)",
                  fill: false
                }]
              },
              options: {
                responsive: true,
                plugins: { title: { display: true, text: "Calorie Forecast" } },
                scales: {
                  x: { title: { display: true, text: "Weeks" } },
                  y: { title: { display: true, text: "Calories" } }
                }
              }
            });
    
            // Macronutrient Trajectory Chart
            if (macroChart) macroChart.destroy();
            const ctxMacro = document.getElementById("macroChart").getContext("2d");
            macroChart = new Chart(ctxMacro, {
              type: "line",
              data: {
                labels: weeks,
                datasets: [
                  { label: "Protein (g)", data: proteins, borderColor: "rgb(255, 99, 132)", fill: false },
                  { label: "Carbs (g)", data: carbs, borderColor: "rgb(54, 162, 235)", fill: false },
                  { label: "Fat (g)", data: fats, borderColor: "rgb(255, 205, 86)", fill: false }
                ]
              },
              options: {
                responsive: true,
                plugins: { title: { display: true, text: "Macronutrient Trajectory" } },
                scales: {
                  x: { title: { display: true, text: "Weeks" } },
                  y: { title: { display: true, text: "Grams" } }
                }
              }
            });
    
            // Weight Loss Trajectory Chart
            if (weightChart) weightChart.destroy();
            const ctxWeight = document.getElementById("weightChart").getContext("2d");
            weightChart = new Chart(ctxWeight, {
              type: "line",
              data: {
                labels: weeks,
                datasets: [{
                  label: "Predicted Weight (lbs)",
                  data: weights,
                  borderColor: "rgb(153, 102, 255)",
                  fill: false
                }]
              },
              options: {
                responsive: true,
                plugins: { title: { display: true, text: "Weight Loss Trajectory" } },
                scales: {
                  x: { title: { display: true, text: "Weeks" } },
                  y: { title: { display: true, text: "Weight (lbs)" } }
                }
              }
            });
          } catch (error) {
            console.error("Error rendering charts:", error);
          }
        }
    
        // --- Navigation & UI Handling ---
        const steps = Array.from(document.querySelectorAll(".wizard-step"));
        let currentStepIndex = 0;
        function showStep(index) {
          steps.forEach((s, i) => s.style.display = i === index ? "block" : "none");
          currentStepIndex = index;
        }
        document.querySelectorAll("[data-next-step]").forEach((btn) => {
          btn.addEventListener("click", () => { if (!validateCurrentStep()) return; showStep(currentStepIndex + 1); });
        });
        document.querySelectorAll("[data-prev-step]").forEach((btn) => {
          btn.addEventListener("click", () => showStep(currentStepIndex - 1));
        });
    
        // --- Toggle between LeanFat and WeightBF ---
        const radioLeanFat = document.getElementById("radioLeanFat");
        const radioWeightBF = document.getElementById("radioWeightBF");
        function updateModeUI() {
          document.getElementById("leanFatSection").style.display = radioLeanFat.checked ? "block" : "none";
          document.getElementById("weightBFSection").style.display = radioWeightBF.checked ? "block" : "none";
        }
        [radioLeanFat, radioWeightBF].forEach(r => r.addEventListener("change", updateModeUI));
        updateModeUI();
    
        // --- Calorie Adjustment Dropdown ---
        const weightGoalRadios = document.getElementsByName("weightGoal");
        const dailyAdjustmentSelect = document.getElementById("dailyAdjustmentSelect");
        function updateCalorieDropdown() {
          let optionsHTML = `
            <option value="-250" selected>Slow loss: (~250 cal/day deficit) ≈ 0.5 lb/week</option>
            <option value="-500">Moderate loss: (~500 cal/day deficit) ≈ 1 lb/week</option>
            <option value="-750">Rapid loss: (~750 cal/day deficit) ≈ 1.5 lb/week</option>
            <option value="-1000">Dangerous loss: (~1,000+ cal/day deficit) ≈ 2 lb/week or more</option>
          `;
          dailyAdjustmentSelect.innerHTML = optionsHTML;
        }
        updateCalorieDropdown();
        Array.from(weightGoalRadios).forEach(r => r.addEventListener("change", updateCalorieDropdown));
    
        // --- Basic Validation ---
        function validateCurrentStep() {
          clearErrors(steps[currentStepIndex]);
          if (currentStepIndex === 1) {
            const ageVal = parseInt(document.getElementById("ageInput").value || "", 10);
            if (isNaN(ageVal) || ageVal < 20 || ageVal > 69) {
              showError(document.getElementById("ageInput"), "Age must be 20-69");
              return false;
            }
          }
          if (currentStepIndex === 2) {
            if (radioLeanFat.checked) {
              const l = parseFloat(document.getElementById("leanMassInput").value);
              const f = parseFloat(document.getElementById("fatMassInput").value);
              if (isNaN(l) || l <= 0) {
                showError(document.getElementById("leanMassInput"), "Invalid lean mass");
                return false;
              }
              if (isNaN(f) || f < 0) {
                showError(document.getElementById("fatMassInput"), "Invalid fat mass");
                return false;
              }
              if (l + f <= 0) {
                showError(document.getElementById("fatMassInput"), "Lean+fat must be >0");
                return false;
              }
            } else {
              const w = parseFloat(document.getElementById("totalWeightInput").value);
              const bf = parseFloat(document.getElementById("bodyFatPctInput").value);
              if (isNaN(w) || w <= 0) {
                showError(document.getElementById("totalWeightInput"), "Invalid weight");
                return false;
              }
              if (isNaN(bf) || bf < 0 || bf > 100) {
                showError(document.getElementById("bodyFatPctInput"), "BF% must be between 0 and 100");
                return false;
              }
            }
          }
          return true;
        }
    
        function clearErrors(stepEl) {
          stepEl.querySelectorAll(".error-message").forEach(e => e.remove());
          stepEl.querySelectorAll(".invalid-input").forEach(inp => inp.classList.remove("invalid-input"));
        }
    
        function showError(inputEl, msg) {
          inputEl.classList.add("invalid-input");
          const e = document.createElement("div");
          e.className = "error-message";
          e.textContent = msg;
          inputEl.insertAdjacentElement("afterend", e);
        }
    
        // --- On Calculate Button ---
        document.getElementById("calculateButton").addEventListener("click", () => {
          clearErrors(steps[currentStepIndex]);
          const wg = document.querySelector('input[name="weightGoal"]:checked');
          const da = document.querySelector('input[name="dietaryApproach"]:checked');
          if (!wg) {
            showError(document.getElementById("loseWeight"), "Select weight goal");
            return;
          }
          if (!da) {
            showError(document.getElementById("lowCarb"), "Select dietary approach");
            return;
          }
          const dailyAdj = parseFloat(document.getElementById("dailyAdjustmentSelect").value) || 0;
          if (dailyAdj > 0) {
            showError(document.getElementById("dailyAdjustmentSelect"), "For weight loss, select a deficit (negative value)");
            return;
          }
          doFinalCalculation();
          showStep(4);
        });
    
        // --- Final Calculation, UI Update, and Chart Rendering ---
        function doFinalCalculation() {
          const isKg = document.getElementById("radioKg").checked;
          let M0 = 0, F0 = 0;
          if (document.getElementById("radioLeanFat").checked) {
            M0 = parseFloat(document.getElementById("leanMassInput").value) || 0;
            F0 = parseFloat(document.getElementById("fatMassInput").value) || 0;
            if (isKg) {
              M0 *= 2.20462;
              F0 *= 2.20462;
            }
          } else {
            let w = parseFloat(document.getElementById("totalWeightInput").value) || 0;
            let bf = parseFloat(document.getElementById("bodyFatPctInput").value) || 0;
            if (isKg) w *= 2.20462;
            F0 = (bf / 100) * w;
            M0 = w - F0;
          }
          const cWeight = M0 + F0;
          setTextContent("currentWeightSpan", fmtWeight(cWeight, isKg));
          setTextContent("currentFatSpan", fmtWeight(F0, isKg) + " (" + (F0 / cWeight * 100).toFixed(1) + "%)");
          setTextContent("currentLeanSpan", fmtWeight(M0, isKg));
          setTextContent("currentBFpctSpan", (F0 / cWeight * 100).toFixed(1) + "%");
          setTextContent("currentBFcatSpan", getBFCat(F0 / cWeight));
    
          // --- Compute Goal Range with Low-High Values ---
          const fatRangeLookup = {
            dangerouslyLow: { pLow: 0.08, pHigh: 0.10 },
            excellent: { pLow: 0.10, pHigh: 0.15 },
            good: { pLow: 0.15, pHigh: 0.20 },
            fair: { pLow: 0.20, pHigh: 0.25 },
            poor: { pLow: 0.25, pHigh: 0.30 },
            dangerouslyHigh: { pLow: 0.30, pHigh: 0.35 }
          };
          const catKey = document.getElementById("fatGoalCategorySelect").value;
          const range = fatRangeLookup[catKey] || { pLow: 0.10, pHigh: 0.15 };
          const goalWeightLow = M0 / (1 - range.pLow);
          const goalWeightHigh = M0 / (1 - range.pHigh);
          const goalFatLow = goalWeightLow - M0;
          const goalFatHigh = goalWeightHigh - M0;
          const goalBFpctLow = (goalFatLow / goalWeightLow) * 100;
          const goalBFpctHigh = (goalFatHigh / goalWeightHigh) * 100;
    
          setTextContent("goalWeightSpan", fmtWeight(goalWeightLow, isKg) + "–" + fmtWeight(goalWeightHigh, isKg));
          setTextContent("goalFatSpan", fmtWeight(goalFatLow, isKg) + "–" + fmtWeight(goalFatHigh, isKg));
          setTextContent("goalLeanSpan", fmtWeight(M0, isKg));
          setTextContent("goalBFpctSpan", goalBFpctLow.toFixed(1) + "%–" + goalBFpctHigh.toFixed(1) + "%");
          setTextContent("goalBFcatSpan", catKey);
    
          // --- Summary Settings ---
          const dietary = document.querySelector('input[name="dietaryApproach"]:checked').value;
          const deficitVal = document.getElementById("dailyAdjustmentSelect").value;
          const leanLossLookup = {
            balanced: {
              "-250": { fat: 90, lean: 10 },
              "-500": { fat: 85, lean: 15 },
              "-750": { fat: 80, lean: 20 },
              "-1000": { fat: 75, lean: 25 }
            },
            "low-carb": {
              "-250": { fat: 87, lean: 13 },
              "-500": { fat: 82, lean: 18 },
              "-750": { fat: 78, lean: 22 },
              "-1000": { fat: 72, lean: 28 }
            },
            "high-protein": {
              "-250": { fat: 95, lean: 5 },
              "-500": { fat: 92, lean: 8 },
              "-750": { fat: 88, lean: 12 },
              "-1000": { fat: 85, lean: 15 }
            }
          };
          const leanInfo = leanLossLookup[dietary] ? leanLossLookup[dietary][deficitVal] : null;
          if (leanInfo) {
            setTextContent("summaryLeanGoalPct", leanInfo.lean + "% lean loss, " + leanInfo.fat + "% fat loss");
          } else {
            setTextContent("summaryLeanGoalPct", "--");
          }
          setTextContent("summaryWeightGoal", "Lose Weight");
          setTextContent("summaryDietApproach", dietary);
          const af = parseFloat(document.getElementById("activityLevelSelect").value) || 1.55;
          setTextContent("summaryActivityLevel", af);
          const dailyAdjVal = parseFloat(document.getElementById("dailyAdjustmentSelect").value) || 0;
          setTextContent("summaryDailyAdj", dailyAdjVal);
    
          // --- Compute BMR, TDEE, and Final Calories ---
          const LMkg = M0 / 2.20462;
          const BMR = 370 + 21.6 * LMkg;
          const TDEE = BMR * af;
          let finalCals = TDEE + dailyAdjVal;
          if (finalCals < 1200) finalCals = 1200;
          setTextContent("bmrSpan", Math.round(BMR));
          setTextContent("tdeeSpan", Math.round(TDEE));
          setTextContent("finalCalsSpan", Math.round(finalCals));
          const netDiff = finalCals - TDEE;
          setTextContent("deficitOrSurplusLine", netDiff > 0 ? ("+" + Math.round(netDiff)) : netDiff < 0 ? Math.round(netDiff) : "0");
    
          // --- Compute Macros ---
          const macros = computeMacros(finalCals, dietary);
          setTextContent("carbsSpan", macros.carbsGrams + " g");
          setTextContent("proteinSpan", macros.proteinGrams + " g");
          setTextContent("fatSpan", macros.fatGrams + " g");
          setTextContent("macroHealthComment", getAdvice(netDiff));
    
          // --- Run Simulation and Render Forecast Charts ---
          try {
            const simParams = {
              initialWeight: cWeight,
              isKg: false,
              bodyFatPct: (F0 / cWeight) * 100,
              leanMass: M0,
              age: parseInt(document.getElementById("ageInput").value) || 30,
              gender: document.querySelector('input[name="gender"]:checked').value,
              activityMultiplier: af,
              weightGoal: "lose",
              deficitFraction: Math.abs(parseFloat(document.getElementById("dailyAdjustmentSelect").value)) / TDEE,
              dietaryApproach: dietary,
              carbTolerance: "Unsure",
              targetBFRange: { min: 15, max: 20 },
              forecastWeeks: 16,
              adaptationFactor: 0.04,
              adaptationCap: 0.20
            };
            const simResult = simulateMetabolicAdaptation(simParams);
            if (simResult && simResult.weeklyData) {
              renderForecastCharts(simResult.weeklyData);
              console.log("Simulation Result:", simResult);
            } else {
              console.error("No simulation data available.");
            }
          } catch (err) {
            console.error("Error in simulation:", err);
          }
    
          // --- Compute Time-to-Mid-Goal ---
          timeToGoal(cWeight, goalWeightLow, finalCals, TDEE, isKg);
        }
    
        // --- Simulation Function ---
        function simulateMetabolicAdaptation(params) {
          try {
            if (typeof params !== "object") throw new Error("Input parameters must be provided in an object.");
            const {
              initialWeight,
              isKg,
              bodyFatPct,
              leanMass,
              age,
              gender,
              activityMultiplier,
              weightGoal,
              deficitFraction,
              dietaryApproach,
              carbTolerance,
              targetBFRange,
              forecastWeeks,
              adaptationFactor = 0.04,
              adaptationCap = 0.20
            } = params;
            if (!initialWeight || initialWeight <= 0) throw new Error("Initial weight must be positive.");
            if (bodyFatPct < 0 || bodyFatPct > 100) throw new Error("Body fat percentage must be 0-100.");
            if (!age || age <= 0) throw new Error("Age must be positive.");
            if (!activityMultiplier || activityMultiplier < 1) throw new Error("Activity multiplier must be >= 1.");
            if (!["lose", "maintain", "gain"].includes(weightGoal)) throw new Error("Invalid weight goal.");
            if (typeof deficitFraction !== "number") throw new Error("Deficit fraction must be a number.");
            if (!["balanced", "low-carb", "high-protein"].includes(dietaryApproach)) throw new Error("Invalid dietary approach.");
            if (!targetBFRange || typeof targetBFRange.min !== "number" || typeof targetBFRange.max !== "number")
              throw new Error("Target BF range must have min and max values.");
            if (!forecastWeeks || forecastWeeks <= 0) throw new Error("Forecast weeks must be at least 1.");
    
            const lbsToKg = (lbs) => lbs / 2.20462;
    
            let currentWeight = initialWeight;
            let currentLeanMass = leanMass && leanMass > 0 ? leanMass : currentWeight * (1 - (bodyFatPct / 100));
            const leanMassKg = isKg ? currentLeanMass : lbsToKg(currentLeanMass);
            const baselineBMR = 370 + 21.6 * leanMassKg;
            const baselineTDEE = baselineBMR * activityMultiplier;
            let initialCalTarget = weightGoal === "lose" ? baselineTDEE * (1 - deficitFraction) :
                                    weightGoal === "gain" ? baselineTDEE * (1 + Math.abs(deficitFraction)) :
                                    baselineTDEE;
            const minCal = gender === "male" ? 1500 : 1200;
            if (initialCalTarget < minCal) initialCalTarget = minCal;
    
            let leanLossPercent;
            switch (dietaryApproach) {
              case "high-protein":
                leanLossPercent = 0.10;
                break;
              case "balanced":
                leanLossPercent = 0.15;
                break;
              case "low-carb":
                leanLossPercent = 0.20;
                break;
              default:
                leanLossPercent = 0.15;
            }
            let proteinMultiplier = weightGoal === "lose" ? (age < 60 ? 2.2 : (gender === "male" ? 2.5 : 2.6)) : 2.0;
            let carbPercent = carbTolerance === "Low" ? 0.20 : 0.35;
    
            const weeklyData = [];
            let cumulativeAdaptation = 0;
            let currentBMR = baselineBMR;
            let currentTDEE = baselineTDEE;
            let currentCalTarget = initialCalTarget;
    
            for (let week = 1; week <= forecastWeeks; week++) {
              const dailyCalDiff = currentTDEE - currentCalTarget;
              const weeklyCalDiff = dailyCalDiff * 7;
              const weightChange = weeklyCalDiff / 3500;
              const leanMassChange = weightGoal === "lose" ? weightChange * leanLossPercent : (weightGoal === "gain" ? -weightChange * 0.50 : 0);
              currentWeight = currentWeight - weightChange;
              currentLeanMass = currentLeanMass - leanMassChange;
              if (currentWeight < 0) currentWeight = 0;
              if (currentLeanMass < 0) currentLeanMass = 0;
              const updatedLeanKg = isKg ? currentLeanMass : lbsToKg(currentLeanMass);
              currentBMR = 370 + 21.6 * updatedLeanKg;
              cumulativeAdaptation += adaptationFactor;
              if (cumulativeAdaptation > adaptationCap) cumulativeAdaptation = adaptationCap;
              currentTDEE = baselineTDEE * (1 - cumulativeAdaptation);
              currentCalTarget = weightGoal === "lose" ? currentTDEE * (1 - deficitFraction) :
                                 weightGoal === "gain" ? currentTDEE * (1 + Math.abs(deficitFraction)) :
                                 currentTDEE;
              if (currentCalTarget < minCal) currentCalTarget = minCal;
    
              const proteinGrams = Math.max(updatedLeanKg * proteinMultiplier, (0.30 * currentCalTarget) / 4);
              const carbGrams = (currentCalTarget * carbPercent) / 4;
              const fatGrams = (currentCalTarget - (proteinGrams * 4 + carbGrams * 4)) / 9;
    
              weeklyData.push({
                week,
                weight: currentWeight,
                calorieTarget: currentCalTarget,
                macros: {
                  protein: Math.round(proteinGrams),
                  carbs: Math.round(carbGrams),
                  fat: Math.round(fatGrams)
                }
              });
            }
    
            return { weeklyData, disclaimer: "This calculator is for informational purposes only. Consult a healthcare professional before making any major changes to your diet or exercise program." };
          } catch (error) {
            console.error("Simulation error:", error);
            return null;
          }
        }
    
        // --- New Scenario Button ---
        document.getElementById("newScenarioBtn").addEventListener("click", () => {
          steps.forEach(s => s.style.display = "none");
          document.querySelectorAll('input[type="number"]').forEach(inp => inp.value = "");
          dailyAdjustmentSelect.value = "0";
          document.getElementById("loseWeight").checked = true;
          document.getElementById("radioLbs").checked = true;
          updateModeUI();
          updateCalorieDropdown();
          showStep(0);
        });
    
        // --- Modal Handlers ---
        document.querySelectorAll("[data-open-modal]").forEach(a => {
          a.addEventListener("click", e => {
            e.preventDefault();
            let modalId = a.getAttribute("data-open-modal");
            document.getElementById(modalId).style.display = "block";
          });
        });
        document.querySelectorAll(".close-modal-btn").forEach(btn => {
          btn.addEventListener("click", () => {
            let id = btn.getAttribute("data-close-modal");
            document.getElementById(id).style.display = "none";
          });
        });
        document.getElementById("disclaimerLink").addEventListener("click", () => {
          document.getElementById("disclaimerModal").style.display = "block";
        });
    
        // --- On Calculate Button ---
        document.getElementById("calculateButton").addEventListener("click", () => {
          clearErrors(steps[currentStepIndex]);
          const wg = document.querySelector('input[name="weightGoal"]:checked');
          const da = document.querySelector('input[name="dietaryApproach"]:checked');
          if (!wg) {
            showError(document.getElementById("loseWeight"), "Select weight goal");
            return;
          }
          if (!da) {
            showError(document.getElementById("lowCarb"), "Select dietary approach");
            return;
          }
          const dailyAdj = parseFloat(document.getElementById("dailyAdjustmentSelect").value) || 0;
          if (dailyAdj > 0) {
            showError(document.getElementById("dailyAdjustmentSelect"), "For weight loss, select a deficit (negative value)");
            return;
          }
          doFinalCalculation();
          showStep(4);
        });
    
        // --- Final Calculation, UI Update, and Chart Rendering ---
        function doFinalCalculation() {
          const isKg = document.getElementById("radioKg").checked;
          let M0 = 0, F0 = 0;
          if (document.getElementById("radioLeanFat").checked) {
            M0 = parseFloat(document.getElementById("leanMassInput").value) || 0;
            F0 = parseFloat(document.getElementById("fatMassInput").value) || 0;
            if (isKg) {
              M0 *= 2.20462;
              F0 *= 2.20462;
            }
          } else {
            let w = parseFloat(document.getElementById("totalWeightInput").value) || 0;
            let bf = parseFloat(document.getElementById("bodyFatPctInput").value) || 0;
            if (isKg) w *= 2.20462;
            F0 = (bf / 100) * w;
            M0 = w - F0;
          }
          const cWeight = M0 + F0;
          setTextContent("currentWeightSpan", fmtWeight(cWeight, isKg));
          setTextContent("currentFatSpan", fmtWeight(F0, isKg) + " (" + (F0 / cWeight * 100).toFixed(1) + "%)");
          setTextContent("currentLeanSpan", fmtWeight(M0, isKg));
          setTextContent("currentBFpctSpan", (F0 / cWeight * 100).toFixed(1) + "%");
          setTextContent("currentBFcatSpan", getBFCat(F0 / cWeight));
    
          // --- Compute Goal Range with Low-High Values ---
          const fatRangeLookup = {
            dangerouslyLow: { pLow: 0.08, pHigh: 0.10 },
            excellent: { pLow: 0.10, pHigh: 0.15 },
            good: { pLow: 0.15, pHigh: 0.20 },
            fair: { pLow: 0.20, pHigh: 0.25 },
            poor: { pLow: 0.25, pHigh: 0.30 },
            dangerouslyHigh: { pLow: 0.30, pHigh: 0.35 }
          };
          const catKey = document.getElementById("fatGoalCategorySelect").value;
          const range = fatRangeLookup[catKey] || { pLow: 0.10, pHigh: 0.15 };
          const goalWeightLow = M0 / (1 - range.pLow);
          const goalWeightHigh = M0 / (1 - range.pHigh);
          const goalFatLow = goalWeightLow - M0;
          const goalFatHigh = goalWeightHigh - M0;
          const goalBFpctLow = (goalFatLow / goalWeightLow) * 100;
          const goalBFpctHigh = (goalFatHigh / goalWeightHigh) * 100;
    
          setTextContent("goalWeightSpan", fmtWeight(goalWeightLow, isKg) + "–" + fmtWeight(goalWeightHigh, isKg));
          setTextContent("goalFatSpan", fmtWeight(goalFatLow, isKg) + "–" + fmtWeight(goalFatHigh, isKg));
          setTextContent("goalLeanSpan", fmtWeight(M0, isKg));
          setTextContent("goalBFpctSpan", goalBFpctLow.toFixed(1) + "%–" + goalBFpctHigh.toFixed(1) + "%");
          setTextContent("goalBFcatSpan", catKey);
    
          // --- Summary Settings ---
          const dietary = document.querySelector('input[name="dietaryApproach"]:checked').value;
          const deficitVal = document.getElementById("dailyAdjustmentSelect").value;
          const leanLossLookup = {
            balanced: {
              "-250": { fat: 90, lean: 10 },
              "-500": { fat: 85, lean: 15 },
              "-750": { fat: 80, lean: 20 },
              "-1000": { fat: 75, lean: 25 }
            },
            "low-carb": {
              "-250": { fat: 87, lean: 13 },
              "-500": { fat: 82, lean: 18 },
              "-750": { fat: 78, lean: 22 },
              "-1000": { fat: 72, lean: 28 }
            },
            "high-protein": {
              "-250": { fat: 95, lean: 5 },
              "-500": { fat: 92, lean: 8 },
              "-750": { fat: 88, lean: 12 },
              "-1000": { fat: 85, lean: 15 }
            }
          };
          const leanInfo = leanLossLookup[dietary] ? leanLossLookup[dietary][deficitVal] : null;
          if (leanInfo) {
            setTextContent("summaryLeanGoalPct", leanInfo.lean + "% lean loss, " + leanInfo.fat + "% fat loss");
          } else {
            setTextContent("summaryLeanGoalPct", "--");
          }
          setTextContent("summaryWeightGoal", "Lose Weight");
          setTextContent("summaryDietApproach", dietary);
          const af = parseFloat(document.getElementById("activityLevelSelect").value) || 1.55;
          setTextContent("summaryActivityLevel", af);
          const dailyAdjVal = parseFloat(document.getElementById("dailyAdjustmentSelect").value) || 0;
          setTextContent("summaryDailyAdj", dailyAdjVal);
    
          // --- Compute BMR, TDEE, and Final Calories ---
          const LMkg = M0 / 2.20462;
          const BMR = 370 + 21.6 * LMkg;
          const TDEE = BMR * af;
          let finalCals = TDEE + dailyAdjVal;
          if (finalCals < 1200) finalCals = 1200;
          setTextContent("bmrSpan", Math.round(BMR));
          setTextContent("tdeeSpan", Math.round(TDEE));
          setTextContent("finalCalsSpan", Math.round(finalCals));
          const netDiff = finalCals - TDEE;
          setTextContent("deficitOrSurplusLine", netDiff > 0 ? ("+" + Math.round(netDiff)) : netDiff < 0 ? Math.round(netDiff) : "0");
    
          // --- Compute Macros ---
          const macros = computeMacros(finalCals, dietary);
          setTextContent("carbsSpan", macros.carbsGrams + " g");
          setTextContent("proteinSpan", macros.proteinGrams + " g");
          setTextContent("fatSpan", macros.fatGrams + " g");
          setTextContent("macroHealthComment", getAdvice(netDiff));
    
          // --- Run Simulation and Render Forecast Charts ---
          try {
            const simParams = {
              initialWeight: cWeight,
              isKg: false,
              bodyFatPct: (F0 / cWeight) * 100,
              leanMass: M0,
              age: parseInt(document.getElementById("ageInput").value) || 30,
              gender: document.querySelector('input[name="gender"]:checked').value,
              activityMultiplier: af,
              weightGoal: "lose",
              deficitFraction: Math.abs(parseFloat(document.getElementById("dailyAdjustmentSelect").value)) / TDEE,
              dietaryApproach: dietary,
              carbTolerance: "Unsure",
              targetBFRange: { min: 15, max: 20 },
              forecastWeeks: 16,
              adaptationFactor: 0.04,
              adaptationCap: 0.20
            };
            const simResult = simulateMetabolicAdaptation(simParams);
            if (simResult && simResult.weeklyData) {
              renderForecastCharts(simResult.weeklyData);
              console.log("Simulation Result:", simResult);
            } else {
              console.error("No simulation data available.");
            }
          } catch (err) {
            console.error("Error in simulation:", err);
          }
    
          // --- Compute Time-to-Mid-Goal ---
          timeToGoal(cWeight, goalWeightLow, finalCals, TDEE, isKg);
        }
    
        // --- Unit Test: Log Simulation Result ---
        try {
          const testSim = simulateMetabolicAdaptation({
            initialWeight: 250,
            isKg: false,
            bodyFatPct: 30,
            age: 45,
            gender: "male",
            activityMultiplier: 1.55,
            weightGoal: "lose",
            deficitFraction: 0.30,
            dietaryApproach: "balanced",
            carbTolerance: "Unsure",
            targetBFRange: { min: 15, max: 20 },
            forecastWeeks: 16,
            adaptationFactor: 0.04,
            adaptationCap: 0.20
          });
          console.log("Unit Test Simulation Result:", testSim);
        } catch (error) {
          console.error("Unit Test Simulation Error:", error);
        }
      })();
    </script>
    
    <footer class="footer-section">
      <div class="container">
        <div class="footer-content">
          <p class="text-white">&copy; 2025 Yutori Labs. All rights reserved.</p>
        </div>
      </div>
    </footer>
  </body>
</html>
