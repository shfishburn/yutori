<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <!-- Responsive viewport and description -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no" />
    <meta name="description" content="Yutori Labs - Body Composition Calculator V1" />
    <title>Body Composition Calculator V1</title>
    <!-- Include Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <!-- Tailwind CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="../styles.css" />
    <link rel="stylesheet" href="calc-styles.css" />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Inline CSS for Modals and Buttons -->
    <style>
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }
      .modal-content {
        background: #fff;
        padding: 1.5rem;
        border-radius: 8px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      .close-modal-btn {
        background: #007BFF;
        color: #fff;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
      }
      .btn {
        background: #007BFF;
        color: #fff;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <nav class="nav-wrapper">
      <div class="container">
        <!-- Update asset path if necessary -->
        <a href="../index.html">
          <img src="/logo_400px_wide.png" alt="Yutori Labs" class="logo" />
        </a>
      </div>
    </nav>
    
    <section id="calculator" class="projects-section">
      <div class="container">
        <h1 class="text-3xl font-bold mb-4">Body Composition Calculator</h1>
        <p class="mb-6">This calculator determines your body composition goals based on the data you provide.</p>
    
        <!-- STEP 1: Your Information (Merged Inputs) -->
        <div class="wizard-step" id="step1" style="display: block;">
          <h2 class="text-xl font-semibold mb-2">Step 1: Your Information</h2>
          <div class="mb-4">
            <label class="block">Select Units (pounds or kilograms):</label>
            <div class="radio-group">
              <label><input type="radio" name="unit" value="lbs" id="radioLbs" checked /> lbs/inches</label>
              <label><input type="radio" name="unit" value="kg" id="radioKg" /> kg/cm</label>
            </div>
          </div>
          <div class="mb-4">
            <label>Height (in inches or cm):</label>
            <input type="number" id="heightInput" class="mb-2" placeholder="e.g., 70 in or 178 cm" />
          </div>
          <div class="mb-4">
            <label>AGE (18 to 75):</label>
            <input type="number" id="ageInput" min="20" max="69" class="mb-2" placeholder="e.g., 18 to 75" />
          </div>
          <div class="mb-4">
            <label>Gender (assigned at birth):</label>
            <div class="radio-group">
              <label><input type="radio" name="gender" value="female" id="radioFemale" checked /> Female</label>
              <label><input type="radio" name="gender" value="male" id="radioMale" /> Male</label>
            </div>
          </div>
          <div class="mb-4">
            <label>Total Weight:</label>
            <input type="number" id="totalWeightInput" class="mb-2" placeholder="e.g., pounds or kilograms" />
          </div>
          <div class="mb-4">
            <label>Body Fat (%):</label>
            <input type="number" id="bodyFatPctInput" step="0.1" class="mb-2" placeholder="e.g., 25 for 25% body fat" />
          </div>
          <div class="wizard-buttons">
            <button type="button" class="btn" data-next-step>Next</button>
          </div>
        </div>
    
        <!-- STEP 2: Goals & Activity -->
        <div class="wizard-step" id="step2">
          <h2 class="text-xl font-semibold mb-2">Step 2: Goals & Activity</h2>
          <!-- Weight goal is fixed to "Lose Weight" -->
          <p><strong>Weight Goal:</strong> Lose Weight</p>
          <p><a href="#" data-open-modal="dietaryApproachModal" class="text-blue-500 underline">Dietary Approach Info</a></p>
          <div class="radio-group mb-4">
            <label><input type="radio" name="dietaryApproach" value="low-carb" id="lowCarb" /> Low-Carb</label>
            <label><input type="radio" name="dietaryApproach" value="high-protein" id="highProtein" /> High-Protein</label>
            <label><input type="radio" name="dietaryApproach" value="balanced" id="balancedMacros" checked /> Balanced</label>
          </div>
          <p><a href="#" data-open-modal="activityLevelModal" class="text-blue-500 underline">Activity Info</a></p>
          <select id="activityLevelSelect" class="mb-4">
            <option value="1.2">Sedentary (1.2)</option>
            <option value="1.375">Light (1.375)</option>
            <option value="1.55" selected>Moderate (1.55)</option>
            <option value="1.725">Very Active (1.725)</option>
            <option value="1.9">Extremely Active (1.9)</option>
          </select>
          <p><a href="#" data-open-modal="calorieDeficitModal" class="text-blue-500 underline">Calorie Deficit Info</a></p>
          <!-- Calorie Deficit is a drop‑down -->
          <select id="dailyAdjustmentSelect" class="mb-4">
            <option value="-250" selected>Slow loss: (~250 cal/day deficit) ≈ 0.5 lb/week</option>
            <option value="-500">Moderate loss: (~500 cal/day deficit) ≈ 1 lb/week</option>
            <option value="-750">Rapid loss: (~750 cal/day deficit) ≈ 1.5 lb/week</option>
            <option value="-1000">Dangerous loss: (~1,000+ cal/day deficit) ≈ 2 lb/week or more</option>
          </select>
          <p><a href="#" data-open-modal="fatRangeModal" class="text-blue-500 underline">Fat% Range Info</a></p>
          <select id="fatGoalCategorySelect" class="mb-4">
            <option value="dangerouslyLow">Dangerously Low</option>
            <option value="excellent" selected>Excellent</option>
            <option value="good">Good</option>
            <option value="fair">Fair</option>
            <option value="poor">Poor</option>
            <option value="dangerouslyHigh">Dangerously High</option>
          </select>
          <div class="wizard-buttons">
            <button type="button" class="btn" data-prev-step>Back</button>
            <button type="button" class="btn" id="calculateButton">Calculate</button>
          </div>
        </div>
    
        <!-- STEP 3: Results -->
        <div class="wizard-step" id="step3">
          <div class="max-w-4xl mx-auto p-4">
            <!-- 2×2 Grid: Current & Goal Body Composition -->
            <h2 class="text-2xl font-bold mb-2">Current Body Composition</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Settings Card (Left) -->
              <div class="bg-white shadow rounded p-4">
                <h3 class="text-xl font-semibold mb-1">Settings</h3>
                <h4 class="text-sm font-medium text-gray-600 mb-2">Current Stats</h4>
                <ul class="space-y-1 text-sm">
                  <li><strong>Goal:</strong> <span id="summaryWeightGoal">Lose Weight</span></li>
                  <li><strong>Age:</strong> <span id="summaryAge">--</span></li>
                  <li><strong>Gender:</strong> <span id="summaryGender">--</span></li>
                  <li><strong>Dietary Approach:</strong> <span id="summaryDietApproach">--</span></li>
                  <li><strong>Activity:</strong> <span id="summaryActivityLevel">--</span></li>
                  <li><strong>Daily Calorie Deficit:</strong> <span id="summaryDailyAdj">--</span></li>
                  <li><strong>Lean Goal:</strong> <span id="summaryLeanGoalPct">--</span></li>
                </ul>
              </div>
              <!-- Current Composition Card (Right) -->
              <div class="bg-white shadow rounded p-4">
                <h3 class="text-xl font-semibold mb-1">Current Stats</h3>
                <h4 class="text-sm font-medium text-gray-600 mb-2">Body Composition</h4>
                <ul class="space-y-1 text-sm">
                  <li><strong>Weight:</strong> <span id="currentWeightSpan">--</span></li>
                  <li><strong>Fat Mass:</strong> <span id="currentFatSpan">--</span></li>
                  <li><strong>Lean Mass:</strong> <span id="currentLeanSpan">--</span></li>
                  <li><strong>BF%:</strong> <span id="currentBFpctSpan">--</span></li>
                  <li><strong>Category:</strong> <span id="currentBFcatSpan">--</span></li>
                </ul>
                <p class="mt-2 text-sm">
                  <a href="#" data-open-modal="bodyCompModal" class="text-blue-500 underline">Learn More about Your Body Composition</a>
                </p>
              </div>
            </div>
    
            <h2 class="text-2xl font-bold mt-8 mb-2">Goal Body Composition</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Goal Card (Left) -->
              <div class="bg-white shadow rounded p-4">
                <h3 class="text-xl font-semibold mb-1">Goal</h3>
                <h4 class="text-sm font-medium text-gray-600 mb-2">Target Range</h4>
                <ul class="space-y-1 text-sm">
                  <li><strong>Weight:</strong> <span id="goalWeightSpan">--</span></li>
                  <li><strong>Fat Mass:</strong> <span id="goalFatSpan">--</span></li>
                  <li><strong>Lean Mass:</strong> <span id="goalLeanSpan">--</span></li>
                  <li><strong>BF%:</strong> <span id="goalBFpctSpan">--</span></li>
                  <li><strong>Category:</strong> <span id="goalBFcatSpan">--</span></li>
                </ul>
                <p class="mt-2 text-sm">
                  <a href="#" data-open-modal="goalRangeModal" class="text-blue-500 underline">Learn More about Your Goal Range</a>
                </p>
              </div>
              <!-- Nutrition Card (Right) -->
              <div class="bg-white shadow rounded p-4">
                <h3 class="text-xl font-semibold mb-1">Nutrition</h3>
                <h4 class="text-sm font-medium text-gray-600 mb-2">Calories & Macros</h4>
                <ul class="space-y-1 text-sm">
                  <li><strong>BMR:</strong> <span id="bmrSpan">--</span></li>
                  <li><strong>TDEE:</strong> <span id="tdeeSpan">--</span></li>
                  <li><strong>Final Cals:</strong> <span id="finalCalsSpan">--</span> (<span id="deficitOrSurplusLine">--</span>)</li>
                  <li><strong>Carbs:</strong> <span id="carbsSpan">--</span></li>
                  <li><strong>Protein:</strong> <span id="proteinSpan">--</span></li>
                  <li><strong>Fat:</strong> <span id="fatSpan">--</span></li>
                  <li id="macroHealthComment" class="italic">--</li>
                </ul>
                <p class="mt-2 text-sm">
                  <a href="#" data-open-modal="calorieMacroModal" class="text-blue-500 underline">Learn More about Your Calorie & Macro Ranges</a>
                </p>
              </div>
            </div>
    
            <!-- Charts: Stacked Vertically -->
            <h2 class="text-2xl font-bold mt-8 mb-2">Charts</h2>
            <div class="grid grid-cols-1 gap-6">
              <!-- Weight Loss Trajectory Chart -->
              <div class="bg-white shadow rounded p-4">
                <h3 class="text-xl font-semibold mb-1">Weight Loss Trajectory</h3>
                <h4 class="text-sm font-medium text-gray-600 mb-2">Projected Weight Over Time</h4>
                <canvas id="weightChart" class="w-full h-64"></canvas>
              </div>
              <!-- Calorie Forecast Chart -->
              <div class="bg-white shadow rounded p-4">
                <h3 class="text-xl font-semibold mb-1">Calorie Forecast</h3>
                <h4 class="text-sm font-medium text-gray-600 mb-2">Daily Calorie Target</h4>
                <canvas id="calorieChart" class="w-full h-64"></canvas>
              </div>
              <!-- Macro Trajectory Chart -->
              <div class="bg-white shadow rounded p-4">
                <h3 class="text-xl font-semibold mb-1">Macro Trajectory</h3>
                <h4 class="text-sm font-medium text-gray-600 mb-2">Protein, Carbs & Fat (g)</h4>
                <canvas id="macroChart" class="w-full h-64"></canvas>
              </div>
              <p class="mt-2 text-sm">
                <a href="#" data-open-modal="forecastModal" class="text-blue-500 underline">Learn More about Forecast Charts</a>
              </p>
            </div>
    
            <!-- Bottom Buttons -->
            <div class="mt-6 text-center">
              <button class="btn px-4 py-2 bg-gray-700 text-white mr-2" id="newScenarioBtn">New Scenario</button>
              <button class="btn px-4 py-2 bg-gray-500 text-white" id="disclaimerLink">Disclaimer</button>
            </div>
          </div>
        </div>
    
      </div>
    </section>
    
    <!-- Modals -->
    <!-- Body Composition Modal -->
    <div class="modal-overlay" id="bodyCompModal">
      <div class="modal-content">
        <h3>Body Composition Details</h3>
        <p>This section shows your current body composition—including your weight, fat mass, lean mass, and BF%—which is used to set realistic goals.</p>
        <button class="close-modal-btn" data-close-modal="bodyCompModal">Close</button>
      </div>
    </div>
    
    <!-- Forecast Charts Modal -->
    <div class="modal-overlay" id="forecastModal">
      <div class="modal-content">
        <h3>Forecast Charts Explanation</h3>
        <p>The charts display your predicted weight loss trajectory, daily calorie target, and macronutrient needs over time. They update dynamically as your metabolic adaptation is simulated.</p>
        <button class="close-modal-btn" data-close-modal="forecastModal">Close</button>
      </div>
    </div>
    
    <!-- Explanation Modal for Settings -->
    <div class="modal-overlay" id="explanationModal">
      <div class="modal-content">
        <h3>How Are These Figures Calculated?</h3>
        <p>
          <strong>Settings:</strong> Your total weight, height, age, and gender are used with the Mifflin–St Jeor equation to compute your Resting Metabolic Rate (RMR):
          <br /><em>For males: (10 × weight_kg) + (6.25 × height_cm) – (5 × age) + 5</em>
          <br /><em>For females: (10 × weight_kg) + (6.25 × height_cm) – (5 × age) – 161</em>
          <br />TDEE is derived by multiplying RMR by your activity multiplier. Your goal weight range is calculated using your target BF percentages.
        </p>
        <button class="close-modal-btn" data-close-modal="explanationModal">Close</button>
      </div>
    </div>
    
    <!-- Explanation Modal for Goal Range -->
    <div class="modal-overlay" id="goalRangeModal">
      <div class="modal-content">
        <h3>Goal Range Explanation</h3>
        <p>
          Your goal weight range is determined by your lean mass (calculated as total weight × [1 – BF%]) and your target BF percentages:
          <br /><em>Goal Weight Low = Lean Mass ÷ (1 – pLow)</em> and <em>Goal Weight High = Lean Mass ÷ (1 – pHigh)</em>.
          For example, a reference user might have:
          <br />Weight: 218.35 lbs–232.00 lbs, Fat Mass: 32.75 lbs–46.40 lbs, Lean Mass: 185.60 lbs, BF%: 15.0%–20.0% (GOOD).
        </p>
        <button class="close-modal-btn" data-close-modal="goalRangeModal">Close</button>
      </div>
    </div>
    
    <!-- Explanation Modal for Calories & Macros -->
    <div class="modal-overlay" id="calorieMacroModal">
      <div class="modal-content">
        <h3>Calories & Macronutrients Explanation</h3>
        <p>
          Your RMR is computed using the Mifflin–St Jeor equation:
          <br /><em>For males: (10 × weight_kg) + (6.25 × height_cm) – (5 × age) + 5</em>
          <br /><em>For females: (10 × weight_kg) + (6.25 × height_cm) – (5 × age) – 161</em>
          <br />TDEE is derived by multiplying RMR by your activity multiplier.
          A relative deficit (selected from the drop‑down) is applied to set your daily calorie target.
          We then use a dynamic effective energy density:
          <em>E_eff = L × 760 + (1 – L) × 3500</em>,
          where L is the fraction of weight loss that is lean tissue, to simulate weight loss and update your macronutrient targets.
        </p>
        <button class="close-modal-btn" data-close-modal="calorieMacroModal">Close</button>
      </div>
    </div>
    
    <!-- Other Modals -->
    <div class="modal-overlay" id="weightGoalModal">
      <div class="modal-content">
        <h3>Weight Goal</h3>
        <p>This calculator supports a weight loss scenario only.</p>
        <button class="close-modal-btn" data-close-modal="weightGoalModal">Exit</button>
      </div>
    </div>
    
    <div class="modal-overlay" id="dietaryApproachModal">
      <div class="modal-content">
        <h3>Dietary Approach</h3>
        <p>Low‑carb, High‑protein, or Balanced macros determine your nutrient split.</p>
        <button class="close-modal-btn" data-close-modal="dietaryApproachModal">Exit</button>
      </div>
    </div>
    
    <div class="modal-overlay" id="activityLevelModal">
      <div class="modal-content">
        <h3>Activity Level</h3>
        <p>Your activity multiplier adjusts your RMR. Examples: Sedentary ~1.2, Very Active ~1.725.</p>
        <button class="close-modal-btn" data-close-modal="activityLevelModal">Exit</button>
      </div>
    </div>
    
    <div class="modal-overlay" id="calorieDeficitModal">
      <div class="modal-content">
        <h3>Calorie Deficit Info</h3>
        <p>
          The calorie deficit drop‑down provides options for a 250, 500, 750, or 1000 cal/day deficit.
          This deficit is applied relative to your TDEE to determine your daily calorie target.
        </p>
        <button class="close-modal-btn" data-close-modal="calorieDeficitModal">Exit</button>
      </div>
    </div>
    
    <div class="modal-overlay" id="fatRangeModal">
      <div class="modal-content">
        <h3>Fat% Range</h3>
        <p>Select a target body‑fat range (for example, "excellent" ~10–15% BF).</p>
        <button class="close-modal-btn" data-close-modal="fatRangeModal">Exit</button>
      </div>
    </div>
    
    <div class="modal-overlay" id="disclaimerModal">
      <div class="modal-content">
        <h3>Disclaimer</h3>
        <p>This is not medical advice. These estimates are based on current research; individual results may vary.
           Consult a healthcare professional for personalized guidance.
        </p>
        <button class="close-modal-btn" data-close-modal="disclaimerModal">Exit</button>
      </div>
    </div>
    
    <script>
      (function () {
        "use strict";
    
        // --- Helper: setTextContent defensively ---
        function setTextContent(id, value) {
          const el = document.getElementById(id);
          if (!el) {
            console.error(`Element with id '${id}' not found.`);
            return;
          }
          el.textContent = value;
        }
    
        // --- Helper Functions ---
        function fmtWeight(weight, isKg) {
          if (typeof weight !== "number") {
            console.error("fmtWeight expects a number; received:", typeof weight);
            return "";
          }
          return isKg ? (weight / 2.20462).toFixed(2) + " kg" : weight.toFixed(2) + " lbs";
        }
    
        function getBFCat(ratio) {
          if (ratio < 0.1) return "Very Low";
          if (ratio < 0.15) return "Excellent";
          if (ratio < 0.2) return "Good";
          if (ratio < 0.25) return "Fair";
          if (ratio < 0.3) return "Poor";
          return "Very High";
        }
    
        function computeMacros(finalCals, approach) {
          let macros = {};
          if (approach === "balanced") {
            macros.carbsGrams = Math.round((finalCals * 0.40) / 4);
            macros.proteinGrams = Math.round((finalCals * 0.30) / 4);
            macros.fatGrams = Math.round((finalCals * 0.30) / 9);
          } else if (approach === "low-carb") {
            macros.carbsGrams = Math.round((finalCals * 0.25) / 4);
            macros.proteinGrams = Math.round((finalCals * 0.40) / 4);
            macros.fatGrams = Math.round((finalCals * 0.35) / 9);
          } else if (approach === "high-protein") {
            macros.carbsGrams = Math.round((finalCals * 0.35) / 4);
            macros.proteinGrams = Math.round((finalCals * 0.45) / 4);
            macros.fatGrams = Math.round((finalCals * 0.20) / 9);
          } else {
            macros.carbsGrams = Math.round((finalCals * 0.40) / 4);
            macros.proteinGrams = Math.round((finalCals * 0.30) / 4);
            macros.fatGrams = Math.round((finalCals * 0.30) / 9);
          }
          return macros;
        }
    
        function getAdvice(netDiff) {
          if (netDiff < 0) return "Calorie deficit: aiming for weight loss.";
          if (netDiff > 0) return "Calorie surplus: aiming for weight gain.";
          return "Calorie maintenance.";
        }
    
        // --- Time-to-Mid-Goal Calculation (not used in current layout) ---
        function timeToGoal(cWeight, goalWeight, finalCals, TDEE, isKg) {
          let netDiff = TDEE - finalCals;
          let absNetDiff = Math.abs(netDiff);
          if (absNetDiff === 0) {
            setTextContent("timeToGoalText", "No calorie change – time cannot be determined.");
            return;
          }
          let weightDiff = Math.abs(cWeight - goalWeight);
          let weeklyChange = (absNetDiff * 7) / 3500;
          if (weeklyChange === 0) {
            setTextContent("timeToGoalText", "Insufficient deficit for measurable weight change.");
            return;
          }
          let weeks = (weightDiff / 2) / weeklyChange;
          weeks = Math.round(weeks * 10) / 10;
          setTextContent("timeToGoalText", weeks + " weeks to mid-goal");
        }
    
        // --- Chart Rendering ---
        let calorieChart, macroChart, weightChart;
        function renderForecastCharts(weeklyData) {
          try {
            const weeks = weeklyData.map(pt => pt.week);
            const calorieTargets = weeklyData.map(pt => Math.round(pt.calorieTarget));
            const weights = weeklyData.map(pt => Math.round(pt.weight));
            const proteins = weeklyData.map(pt => pt.macros.protein);
            const carbs = weeklyData.map(pt => pt.macros.carbs);
            const fats = weeklyData.map(pt => pt.macros.fat);
    
            if (calorieChart && typeof calorieChart.destroy === "function") calorieChart.destroy();
            if (macroChart && typeof macroChart.destroy === "function") macroChart.destroy();
            if (weightChart && typeof weightChart.destroy === "function") weightChart.destroy();
    
            const ctxCal = document.getElementById("calorieChart").getContext("2d");
            calorieChart = new Chart(ctxCal, {
              type: "line",
              data: {
                labels: weeks,
                datasets: [{
                  label: "Daily Calorie Target",
                  data: calorieTargets,
                  borderColor: "rgb(75, 192, 192)",
                  fill: false
                }]
              },
              options: {
                responsive: true,
                plugins: { title: { display: true, text: "Calorie Forecast" } },
                scales: {
                  x: { title: { display: true, text: "Weeks" } },
                  y: { title: { display: true, text: "Calories" } }
                }
              }
            });
    
            const ctxMacro = document.getElementById("macroChart").getContext("2d");
            macroChart = new Chart(ctxMacro, {
              type: "line",
              data: {
                labels: weeks,
                datasets: [
                  { label: "Protein (g)", data: proteins, borderColor: "rgb(255, 99, 132)", fill: false },
                  { label: "Carbs (g)", data: carbs, borderColor: "rgb(54, 162, 235)", fill: false },
                  { label: "Fat (g)", data: fats, borderColor: "rgb(255, 205, 86)", fill: false }
                ]
              },
              options: {
                responsive: true,
                plugins: { title: { display: true, text: "Macro Trajectory" } },
                scales: {
                  x: { title: { display: true, text: "Weeks" } },
                  y: { title: { display: true, text: "Grams" } }
                }
              }
            });
    
            const ctxWeight = document.getElementById("weightChart").getContext("2d");
            weightChart = new Chart(ctxWeight, {
              type: "line",
              data: {
                labels: weeks,
                datasets: [{
                  label: "Predicted Weight (lbs)",
                  data: weights,
                  borderColor: "rgb(153, 102, 255)",
                  fill: false
                }]
              },
              options: {
                responsive: true,
                plugins: { title: { display: true, text: "Weight Loss Trajectory" } },
                scales: {
                  x: { title: { display: true, text: "Weeks" } },
                  y: { title: { display: true, text: "Weight (lbs)" } }
                }
              }
            });
          } catch (error) {
            console.error("Error rendering charts:", error);
          }
        }
    
        // --- Simulation Function using Mifflin–St Jeor ---
        function simulateMetabolicAdaptation(params) {
          try {
            if (typeof params !== "object") throw new Error("Input parameters must be provided in an object.");
            const {
              initialWeight,
              isKg,
              bodyFatPct,
              leanMass,
              age,
              gender,
              activityMultiplier,
              weightGoal,
              deficitFraction,
              dietaryApproach,
              carbTolerance,
              targetBFRange,
              forecastWeeks,
              adaptationFactor = 0.02,
              adaptationCap = 0.20
            } = params;
            if (!initialWeight || initialWeight <= 0) throw new Error("Initial weight must be positive.");
            if (bodyFatPct < 0 || bodyFatPct > 100) throw new Error("Body fat percentage must be 0-100.");
            if (!age || age <= 0) throw new Error("Age must be positive.");
            if (!activityMultiplier || activityMultiplier < 1) throw new Error("Activity multiplier must be >= 1.");
            if (!["lose"].includes(weightGoal)) throw new Error("Only weight loss is supported.");
            if (typeof deficitFraction !== "number") throw new Error("Deficit fraction must be a number.");
            if (!["balanced", "low-carb", "high-protein"].includes(dietaryApproach))
              throw new Error("Invalid dietary approach.");
            if (!targetBFRange || typeof targetBFRange.min !== "number" || typeof targetBFRange.max !== "number")
              throw new Error("Target BF range must have min and max values.");
            if (!forecastWeeks || forecastWeeks <= 0) throw new Error("Forecast weeks must be at least 1.");
    
            // Convert weight to kg if needed
            const lbsToKg = (lbs) => lbs / 2.20462;
            const unit = document.querySelector('input[name="unit"]:checked').value;
            let weightKg = unit === "lbs" ? lbsToKg(initialWeight) : initialWeight;
    
            // Convert height to cm (if unit is lbs then height is in inches)
            let heightInput = parseFloat(document.getElementById("heightInput").value);
            if (isNaN(heightInput) || heightInput <= 0) throw new Error("Height must be provided.");
            let heightCm = unit === "lbs" ? (heightInput * 2.54) : heightInput;
    
            // Compute RMR using Mifflin–St Jeor
            let baselineRMR;
            if (gender === "male") {
              baselineRMR = (10 * weightKg) + (6.25 * heightCm) - (5 * age) + 5;
            } else {
              baselineRMR = (10 * weightKg) + (6.25 * heightCm) - (5 * age) - 161;
            }
    
            // For simulation, compute lean mass from total weight and BF%
            let currentWeight = initialWeight;
            let currentLeanMass = initialWeight * (1 - (bodyFatPct / 100));
            const baselineTDEE = baselineRMR * activityMultiplier;
            let initialCalTarget = baselineTDEE * (1 - deficitFraction);
            const minCal = gender === "male" ? 1500 : 1200;
            if (initialCalTarget < minCal) initialCalTarget = minCal;
    
            let leanLossPercent;
            switch (dietaryApproach) {
              case "high-protein":
                leanLossPercent = 0.10;
                break;
              case "balanced":
                leanLossPercent = 0.15;
                break;
              case "low-carb":
                leanLossPercent = 0.20;
                break;
              default:
                leanLossPercent = 0.15;
            }
            // For low-carb, force carb percent to 20%
            let carbPercent = dietaryApproach === "low-carb" ? 0.20 : (carbTolerance === "Low" ? 0.20 : 0.35);
    
            // IMPORTANT: When calculating protein, convert lean mass (in lbs) to kg if needed
            let proteinMultiplier = (age < 60) ? 2.2 : (gender === "male" ? 2.5 : 2.6);
    
            const weeklyData = [];
            let cumulativeAdaptation = 0;
            let currentRMR = baselineRMR;
            let currentTDEE = baselineTDEE;
            let currentCalTarget = initialCalTarget;
    
            for (let week = 1; week <= forecastWeeks; week++) {
              const dailyCalDiff = currentTDEE - currentCalTarget;
              const weeklyCalDiff = dailyCalDiff * 7;
    
              // Dynamic effective energy density: E_eff = L × 760 + (1 – L) × 3500
              const L = leanLossPercent;
              const E_eff = L * 760 + (1 - L) * 3500;
    
              // Weight change (in lbs) = weeklyCalDiff / E_eff
              const weightChange = weeklyCalDiff / E_eff;
              // Compute lean mass change (note: currentLeanMass is in lbs; conversion will occur when computing protein)
              const leanMassChange = weightChange * leanLossPercent;
    
              currentWeight = currentWeight - weightChange;
              currentLeanMass = currentLeanMass - leanMassChange;
              if (currentWeight < 0) currentWeight = 0;
              if (currentLeanMass < 0) currentLeanMass = 0;
    
              // Update RMR based on new weight (keep height, age, gender constant)
              let newWeightKg = unit === "lbs" ? lbsToKg(currentWeight) : currentWeight;
              if (gender === "male") {
                currentRMR = (10 * newWeightKg) + (6.25 * heightCm) - (5 * age) + 5;
              } else {
                currentRMR = (10 * newWeightKg) + (6.25 * heightCm) - (5 * age) - 161;
              }
    
              cumulativeAdaptation += adaptationFactor;
              if (cumulativeAdaptation > adaptationCap) cumulativeAdaptation = adaptationCap;
              currentTDEE = baselineTDEE * (1 - cumulativeAdaptation);
              currentCalTarget = currentTDEE * (1 - deficitFraction);
              if (currentCalTarget < minCal) currentCalTarget = minCal;
    
              // Compute protein target using lean mass converted to kg
              const proteinGrams = Math.max((unit === "lbs" ? lbsToKg(currentLeanMass) : currentLeanMass) * proteinMultiplier, (0.30 * currentCalTarget) / 4);
              const carbGrams = (currentCalTarget * carbPercent) / 4;
              const fatGrams = (currentCalTarget - (proteinGrams * 4 + carbGrams * 4)) / 9;
    
              weeklyData.push({
                week,
                weight: currentWeight,
                TDEE: currentTDEE,
                calorieTarget: currentCalTarget,
                macros: {
                  protein: Math.round(proteinGrams),
                  carbs: Math.round(carbGrams),
                  fat: Math.round(fatGrams)
                }
              });
            }
    
            return {
              weeklyData,
              disclaimer: "This calculator is for informational purposes only. Consult a healthcare professional before making any major changes to your diet or exercise program."
            };
          } catch (error) {
            console.error("Simulation error:", error);
            return null;
          }
        }
    
        // --- New Scenario Button ---
        document.getElementById("newScenarioBtn").addEventListener("click", () => {
          steps.forEach(s => s.style.display = "none");
          document.querySelectorAll('input[type="number"]').forEach(inp => inp.value = "");
          dailyAdjustmentSelect.value = "-250";
          document.getElementById("radioLbs").checked = true;
          showStep(0);
        });
    
        // --- Modal Handlers ---
        document.querySelectorAll("[data-open-modal]").forEach(a => {
          a.addEventListener("click", e => {
            e.preventDefault();
            let modalId = a.getAttribute("data-open-modal");
            document.getElementById(modalId).style.display = "flex";
          });
        });
        document.querySelectorAll(".close-modal-btn").forEach(btn => {
          btn.addEventListener("click", () => {
            let id = btn.getAttribute("data-close-modal");
            document.getElementById(id).style.display = "none";
          });
        });
        document.getElementById("disclaimerLink").addEventListener("click", () => {
          document.getElementById("disclaimerModal").style.display = "flex";
        });
    
        // --- Navigation & UI Handling ---
        const steps = Array.from(document.querySelectorAll(".wizard-step"));
        let currentStepIndex = 0;
        function showStep(index) {
          steps.forEach((s, i) => s.style.display = i === index ? "block" : "none");
          currentStepIndex = index;
        }
        document.querySelectorAll("[data-next-step]").forEach((btn) => {
          btn.addEventListener("click", () => { if (!validateCurrentStep()) return; showStep(currentStepIndex + 1); });
        });
        document.querySelectorAll("[data-prev-step]").forEach((btn) => {
          btn.addEventListener("click", () => showStep(currentStepIndex - 1));
        });
    
        // --- Calorie Adjustment Dropdown ---
        const weightGoalRadios = document.getElementsByName("weightGoal");
        function updateCalorieDropdown() {
          let optionsHTML = `
            <option value="-250" selected>Slow loss: (~250 cal/day deficit) ≈ 0.5 lb/week</option>
            <option value="-500">Moderate loss: (~500 cal/day deficit) ≈ 1 lb/week</option>
            <option value="-750">Rapid loss: (~750 cal/day deficit) ≈ 1.5 lb/week</option>
            <option value="-1000">Dangerous loss: (~1,000+ cal/day deficit) ≈ 2 lb/week or more</option>
          `;
          dailyAdjustmentSelect.innerHTML = optionsHTML;
        }
        updateCalorieDropdown();
        Array.from(weightGoalRadios).forEach(r => r.addEventListener("change", updateCalorieDropdown));
    
        // --- Basic Validation ---
        function validateCurrentStep() {
          clearErrors(steps[currentStepIndex]);
          // In merged step 1, validate height, age, weight and BF%
          if (currentStepIndex === 0) {
            const heightVal = parseFloat(document.getElementById("heightInput").value);
            const ageVal = parseInt(document.getElementById("ageInput").value || "", 10);
            const weightVal = parseFloat(document.getElementById("totalWeightInput").value);
            const bfVal = parseFloat(document.getElementById("bodyFatPctInput").value);
            if (isNaN(heightVal) || heightVal <= 0) {
              showError(document.getElementById("heightInput"), "Height must be provided and positive.");
              return false;
            }
            if (isNaN(ageVal) || ageVal < 18 || ageVal > 75) {
              showError(document.getElementById("ageInput"), "Age must be 18-75");
              return false;
            }
            if (isNaN(weightVal) || weightVal <= 0) {
              showError(document.getElementById("totalWeightInput"), "Invalid weight");
              return false;
            }
            if (isNaN(bfVal) || bfVal < 0 || bfVal > 100) {
              showError(document.getElementById("bodyFatPctInput"), "BF% must be between 8% and 40%");
              return false;
            }
          }
          return true;
        }
    
        function clearErrors(stepEl) {
          stepEl.querySelectorAll(".error-message").forEach(e => e.remove());
          stepEl.querySelectorAll(".invalid-input").forEach(inp => inp.classList.remove("invalid-input"));
        }
    
        function showError(inputEl, msg) {
          inputEl.classList.add("invalid-input");
          const e = document.createElement("div");
          e.className = "error-message";
          e.textContent = msg;
          inputEl.insertAdjacentElement("afterend", e);
        }
    
        // --- On Calculate Button ---
        document.getElementById("calculateButton").addEventListener("click", () => {
          clearErrors(steps[currentStepIndex]);
          const dailyAdj = parseFloat(document.getElementById("dailyAdjustmentSelect").value) || 0;
          if (dailyAdj > 0) {
            showError(document.getElementById("dailyAdjustmentSelect"), "For weight loss, select a deficit (negative value)");
            return;
          }
          doFinalCalculation();
          showStep(2);
        });
    
        // --- Final Calculation, UI Update, and Chart Rendering ---
        function doFinalCalculation() {
          const unit = document.querySelector('input[name="unit"]:checked').value;
          const isKg = unit === "kg";
          const weightVal = parseFloat(document.getElementById("totalWeightInput").value);
          const bfVal = parseFloat(document.getElementById("bodyFatPctInput").value);
          const ageVal = parseInt(document.getElementById("ageInput").value) || 30;
          const gender = document.querySelector('input[name="gender"]:checked').value;
          const heightVal = parseFloat(document.getElementById("heightInput").value);
          const heightCm = unit === "lbs" ? (heightVal * 2.54) : heightVal;
          const lbsToKg = (lbs) => lbs / 2.20462;
          const weightKg = unit === "lbs" ? lbsToKg(weightVal) : weightVal;
    
          // Compute RMR using Mifflin–St Jeor
          let RMR;
          if (gender === "male") {
            RMR = (10 * weightKg) + (6.25 * heightCm) - (5 * ageVal) + 5;
          } else {
            RMR = (10 * weightKg) + (6.25 * heightCm) - (5 * ageVal) - 161;
          }
    
          // Compute lean mass from total weight and BF%
          const leanMass = weightVal * (1 - (bfVal / 100));
          const cWeight = unit === "lbs" ? weightVal : (weightVal * 2.20462);
          setTextContent("currentWeightSpan", fmtWeight(cWeight, false));
          const fatMass = weightVal * (bfVal / 100);
          setTextContent("currentFatSpan", fmtWeight(fatMass, false) + " (" + ((fatMass / weightVal) * 100).toFixed(1) + "%)");
          setTextContent("currentLeanSpan", fmtWeight(leanMass, false));
          setTextContent("currentBFpctSpan", ((fatMass / weightVal) * 100).toFixed(1) + "%");
          setTextContent("currentBFcatSpan", getBFCat(fatMass / weightVal));
    
          // --- Compute Goal Range (Low-High) ---
          const fatRangeLookup = {
            dangerouslyLow: { pLow: 0.08, pHigh: 0.10 },
            excellent: { pLow: 0.10, pHigh: 0.15 },
            good: { pLow: 0.15, pHigh: 0.20 },
            fair: { pLow: 0.20, pHigh: 0.25 },
            poor: { pLow: 0.25, pHigh: 0.30 },
            dangerouslyHigh: { pLow: 0.30, pHigh: 0.35 }
          };
          const catKey = document.getElementById("fatGoalCategorySelect").value;
          const range = fatRangeLookup[catKey] || { pLow: 0.10, pHigh: 0.15 };
          const goalWeightLow = leanMass / (1 - range.pLow);
          const goalWeightHigh = leanMass / (1 - range.pHigh);
          const goalFatLow = goalWeightLow - leanMass;
          const goalFatHigh = goalWeightHigh - leanMass;
          const goalBFpctLow = (goalFatLow / goalWeightLow) * 100;
          const goalBFpctHigh = (goalFatHigh / goalWeightHigh) * 100;
    
          setTextContent("goalWeightSpan", fmtWeight(goalWeightLow, false) + "–" + fmtWeight(goalWeightHigh, false));
          setTextContent("goalFatSpan", fmtWeight(goalFatLow, false) + "–" + fmtWeight(goalFatHigh, false));
          setTextContent("goalLeanSpan", fmtWeight(leanMass, false));
          setTextContent("goalBFpctSpan", goalBFpctLow.toFixed(1) + "%–" + goalBFpctHigh.toFixed(1) + "%");
          setTextContent("goalBFcatSpan", catKey);
    
          // --- Summary Settings (Settings Card) ---
          const dietary = document.querySelector('input[name="dietaryApproach"]:checked').value;
          setTextContent("summaryAge", document.getElementById("ageInput").value || "--");
          setTextContent("summaryGender", gender || "--");
          const deficitVal = document.getElementById("dailyAdjustmentSelect").value;
          const leanLossLookup = {
            balanced: {
              "-250": { fat: 90, lean: 10 },
              "-500": { fat: 85, lean: 15 },
              "-750": { fat: 80, lean: 20 },
              "-1000": { fat: 75, lean: 25 }
            },
            "low-carb": {
              "-250": { fat: 87, lean: 13 },
              "-500": { fat: 82, lean: 18 },
              "-750": { fat: 78, lean: 22 },
              "-1000": { fat: 72, lean: 28 }
            },
            "high-protein": {
              "-250": { fat: 95, lean: 5 },
              "-500": { fat: 92, lean: 8 },
              "-750": { fat: 88, lean: 12 },
              "-1000": { fat: 85, lean: 15 }
            }
          };
          const leanInfo = leanLossLookup[dietary] ? leanLossLookup[dietary][deficitVal] : null;
          if (leanInfo) {
            setTextContent("summaryLeanGoalPct", leanInfo.lean + "% lean loss, " + leanInfo.fat + "% fat loss");
          } else {
            setTextContent("summaryLeanGoalPct", "--");
          }
          setTextContent("summaryWeightGoal", "Lose Weight");
          setTextContent("summaryDietApproach", dietary);
          const af = parseFloat(document.getElementById("activityLevelSelect").value) || 1.55;
          setTextContent("summaryActivityLevel", af);
          const dailyAdjVal = parseFloat(document.getElementById("dailyAdjustmentSelect").value) || 0;
          setTextContent("summaryDailyAdj", dailyAdjVal);
    
          // --- Compute RMR, TDEE, and Final Calories using Mifflin–St Jeor ---
          let RMR_final;
          if (gender === "male") {
            RMR_final = (10 * weightKg) + (6.25 * heightCm) - (5 * ageVal) + 5;
          } else {
            RMR_final = (10 * weightKg) + (6.25 * heightCm) - (5 * ageVal) - 161;
          }
          const TDEE = RMR_final * af;
          let finalCals = TDEE + dailyAdjVal;
          if (finalCals < 1200) finalCals = 1200;
    
          // --- Run Simulation with Dynamic Energy Density ---
          const simParams = {
            initialWeight: cWeight,
            isKg: false,
            bodyFatPct: bfVal,
            leanMass: leanMass,
            age: ageVal,
            gender: gender,
            activityMultiplier: af,
            weightGoal: "lose",
            deficitFraction: Math.abs(parseFloat(document.getElementById("dailyAdjustmentSelect").value)) / TDEE,
            dietaryApproach: dietary,
            carbTolerance: "Unsure",
            targetBFRange: { min: 15, max: 20 },
            forecastWeeks: 16,
            adaptationFactor: 0.02,
            adaptationCap: 0.20
          };
          const simResult = simulateMetabolicAdaptation(simParams);
          if (simResult && simResult.weeklyData) {
            const calArray = simResult.weeklyData.map(x => x.calorieTarget);
            const tdeeArray = simResult.weeklyData.map(x => x.TDEE);
            const proteinArray = simResult.weeklyData.map(x => x.macros.protein);
            const carbsArray = simResult.weeklyData.map(x => x.macros.carbs);
            const fatArray = simResult.weeklyData.map(x => x.macros.fat);
    
            const finalCalsLow = Math.min(...calArray);
            const finalCalsHigh = Math.max(...calArray);
            const tdeeLow = Math.min(...tdeeArray);
            const tdeeHigh = Math.max(...tdeeArray);
            const proteinLow = Math.min(...proteinArray);
            const proteinHigh = Math.max(...proteinArray);
            const carbsLow = Math.min(...carbsArray);
            const carbsHigh = Math.max(...carbsArray);
            const fatLow = Math.min(...fatArray);
            const fatHigh = Math.max(...fatArray);
    
            setTextContent("bmrSpan", Math.round(RMR_final) + " kcal/day");
            setTextContent("tdeeSpan", Math.round(tdeeLow) + "–" + Math.round(tdeeHigh) + " kcal/day");
            setTextContent("finalCalsSpan", Math.round(finalCalsLow) + "–" + Math.round(finalCalsHigh) + " kcal/day");
            setTextContent("carbsSpan", Math.round(carbsLow) + "–" + Math.round(carbsHigh) + " g");
            setTextContent("proteinSpan", Math.round(proteinLow) + "–" + Math.round(proteinHigh) + " g");
            setTextContent("fatSpan", Math.round(fatLow) + "–" + Math.round(fatHigh) + " g");
            setTextContent("macroHealthComment", getAdvice(finalCals - TDEE));
    
            renderForecastCharts(simResult.weeklyData);
            console.log("Simulation Result:", simResult);
    
            // --- Additional Explanation for Goal Range Card ---
            const weightArray = simResult.weeklyData.map(x => x.weight);
            const initialSimWeight = cWeight;
            const finalSimWeight = weightArray[weightArray.length - 1];
            const avgWeeklyLoss = (initialSimWeight - finalSimWeight) / simResult.weeklyData.length;
            const midGoalWeight = (goalWeightLow + goalWeightHigh) / 2;
            const weeksToGoal = (cWeight - midGoalWeight) / (avgWeeklyLoss || 1);
            const currentDate = new Date();
            const projectedGoalDate = new Date(currentDate.getTime() + weeksToGoal * 7 * 24 * 60 * 60 * 1000);
            const extraInfo = document.createElement("p");
            extraInfo.className = "mt-2 text-sm text-gray-700";
            extraInfo.textContent = `For a reference user, the Goal Range is:
Weight: ${fmtWeight(goalWeightLow, false)}–${fmtWeight(goalWeightHigh, false)},
Fat Mass: ${fmtWeight(goalFatLow, false)}–${fmtWeight(goalFatHigh, false)},
Lean Mass: ${fmtWeight(leanMass, false)},
BF%: ${goalBFpctLow.toFixed(1)}%–${goalBFpctHigh.toFixed(1)}% (${catKey.toUpperCase()}).
Based on current projections, you should lose up to ${avgWeeklyLoss.toFixed(2)} lbs per week.
Over ${simResult.weeklyData.length} weeks, you will lose a total of ${(initialSimWeight - finalSimWeight).toFixed(2)} lbs.`;
            const goalRangeCard = document.querySelector("#goalWeightSpan").parentElement.parentElement;
            if (goalRangeCard) goalRangeCard.appendChild(extraInfo);
          } else {
            console.error("No simulation data available.");
          }
        }
    
        // --- Unit Test: Log Simulation Result for our reference user ---
        try {
          const testSim = simulateMetabolicAdaptation({
            initialWeight: 287.5,
            isKg: false,
            bodyFatPct: 35.7,
            age: 62,
            gender: "male",
            activityMultiplier: 1.55,
            weightGoal: "lose",
            deficitFraction: 0.50,  // Moderate loss (~500 cal/day deficit)
            dietaryApproach: "low-carb",
            carbTolerance: "Unsure",
            targetBFRange: { min: 15, max: 20 },
            forecastWeeks: 16,
            adaptationFactor: 0.02,
            adaptationCap: 0.20
          });
          console.log("Unit Test Simulation Result:", testSim);
        } catch (error) {
          console.error("Unit Test Simulation Error:", error);
        }
      })();

  </script>

    <footer class="footer-section">
      <div class="container">
        <div class="footer-content">
          <p class="text-white">&copy; 2025 Yutori Labs. All rights reserved.</p>
        </div>
      </div>
    </footer>
  </body>
</html>
