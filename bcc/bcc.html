<!--
/**
 * Body Composition Calculator - Main Application Entry
 * 
 * @fileOverview Core HTML template and module initialization
 * @author Yutori Labs
 * @version 1.0.1
 * @created 2024-02-06
 * @updated 2024-02-08
 * @timestamp 14:55:33 UTC
 * 
 * Changelog:
 * - Enhanced diagnostic logging
 * - Improved module initialization tracing
 */
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Body Composition Calculator</title>
    
    <!-- Preload Critical Assets -->
    <link rel="preload" href="src/styles/styles.css" as="style">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" as="style">
    
    <!-- Stylesheets -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="src/styles/styles.css" rel="stylesheet">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- Performance and Error Handling Meta -->
    <meta name="description" content="Precise Body Composition Calculator - Scientific Approach to Fitness Goals">
    <meta name="robots" content="index, follow">

    <style>
        /* Diagnostic Overlay Styles */
        #diagnosticOverlay {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            z-index: 9999;
            font-family: monospace;
            max-width: 300px;
            max-height: 200px;
            overflow: auto;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans leading-normal tracking-normal">
    <!-- Diagnostic Overlay -->
    <div id="diagnosticOverlay"></div>

    <div id="app-container" class="min-h-screen flex flex-col">
        <!-- Navigation -->
        <nav class="bg-white shadow-md">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <img src="assets/logo_400px_wide.png" alt="Yutori Labs Logo" class="h-10">
                <div id="nav-actions" class="flex items-center space-x-4">
                    <button id="theme-toggle" class="text-gray-600 hover:text-gray-900">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Calculator Container -->
        <main class="flex-grow container mx-auto px-4 py-8">
            <div id="calculatorRoot" class="max-w-2xl mx-auto bg-white shadow-lg rounded-lg p-6">
                <!-- Loading State -->
                <div class="text-center py-12">
                    <div class="spinner animate-spin inline-block w-8 h-8 border-4 border-blue-500 rounded-full border-t-transparent"></div>
                    <p class="mt-4 text-gray-600">Loading Body Composition Calculator...</p>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white py-6">
            <div class="container mx-auto px-4 text-center">
                <p>&copy; 2025 Yutori Labs. All Rights Reserved.</p>
                <nav class="mt-4 space-x-4">
                    <a href="#" class="text-gray-300 hover:text-white">Privacy Policy</a>
                    <a href="#" class="text-gray-300 hover:text-white">Terms of Service</a>
                </nav>
            </div>
        </footer>
    </div>

    <!-- Core Module Initialization -->
    <script type="module">
        // Import core modules first
        import calculatorState from './src/core/state.js';
        import errorManager from './src/ui/error-manager.js';
        import { UIOrchestrator } from './src/ui/orchestrator.js';
        import calculatorTemplates from './src/templates/templates.js';
        import eventHandler from './src/ui/event-handler.js';
        import step1Module from './src/steps/step1.js';
        import step2Module from './src/steps/step2.js';
        import step3Module from './src/steps/step3.js';
        import step4Module from './src/steps/step4.js';
        import step5Module from './src/steps/step5.js';
        
        // Diagnostic Overlay Function
        function updateDiagnosticOverlay(message) {
            const overlay = document.getElementById('diagnosticOverlay');
            const timestamp = new Date().toLocaleTimeString();
            overlay.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            overlay.scrollTop = overlay.scrollHeight;
        }

        // Enhanced Logging and Error Tracking
        window.addEventListener('error', (event) => {
            updateDiagnosticOverlay(`ðŸš¨ Error: ${event.message}`);
            console.error('Global Error:', event);
        });

        window.addEventListener('unhandledrejection', (event) => {
            updateDiagnosticOverlay(`ðŸš¨ Unhandled Promise Rejection: ${event.reason}`);
            console.error('Unhandled Promise Rejection:', event.reason);
        });
        
        // Attach core modules to window
        window.calculatorState = calculatorState;
        window.errorManager = errorManager;
        window.UIOrchestrator = UIOrchestrator;
        window.uiOrchestrator = new UIOrchestrator();
        window.eventHandler = eventHandler;
        window.calculatorTemplates = calculatorTemplates;
        window.step1Module = step1Module;
        window.step2Module = step2Module;
        window.step3Module = step3Module;
        window.step4Module = step4Module;
        window.step5Module = step5Module;

        // Centralized Application Initialization
        class BodyCompCalculatorApp {
            constructor() {
                this.errorManager = errorManager;
                this.uiOrchestrator = window.uiOrchestrator;
                updateDiagnosticOverlay('ðŸš€ Application Initializing');
            }

            async init() {
                try {
                    updateDiagnosticOverlay('ðŸ” Initializing Modules');
                    
                    // Verify module availability
                    const requiredModules = [
                        'calculatorState', 
                        'uiOrchestrator', 
                        'calculatorTemplates', 
                        'eventHandler'
                    ];
                    
                    requiredModules.forEach(module => {
                        if (!window[module]) {
                            throw new Error(`Missing required module: ${module}`);
                        }
                        updateDiagnosticOverlay(`âœ… Module Loaded: ${module}`);
                    });

                    // Initialize UI Orchestrator
                    await this.uiOrchestrator.init();
                    updateDiagnosticOverlay('âœ… UI Orchestrator Initialized');

                    // Attach global error handlers
                    this.attachGlobalErrorHandlers();
                    
                    updateDiagnosticOverlay('ðŸŽ‰ Application Initialization Complete');
                } catch (error) {
                    updateDiagnosticOverlay(`ðŸš¨ Initialization Failed: ${error.message}`);
                    this.errorManager.displayFatalError(
                        'Application Initialization Failed', 
                        error
                    );
                }
            }

            attachGlobalErrorHandlers() {
                updateDiagnosticOverlay('ðŸ›¡ï¸ Attaching Global Error Handlers');
            }
        }

        // Initialize on DOM load
        document.addEventListener('DOMContentLoaded', async () => {
            updateDiagnosticOverlay('ðŸ“¦ DOM Fully Loaded');
            const app = new BodyCompCalculatorApp();
            await app.init();
        });
    </script>
</body>
</html>